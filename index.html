<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Zous&#39;blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Androoid分享，编程之路">
<meta property="og:type" content="website">
<meta property="og:title" content="Zous'blog">
<meta property="og:url" content="http://up9527.com/index.html">
<meta property="og:site_name" content="Zous'blog">
<meta property="og:description" content="Androoid分享，编程之路">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zous'blog">
<meta name="twitter:description" content="Androoid分享，编程之路">
  
    <link rel="alternative" href="/atom.xml" title="Zous&#39;blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.png" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">Zous</a></h1>
        </hgroup>

        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:nimdanoob@163.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/nimdanoob" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <li><a href="/tags/bitmap/" style="font-size: 10px;">-bitmap</a></li> <li><a href="/tags/activity/" style="font-size: 10px;">activity</a></li> <li><a href="/tags/android/" style="font-size: 10px;">android</a></li> <li><a href="/tags/markdown/" style="font-size: 10px;">markdown</a></li> <li><a href="/tags/开发/" style="font-size: 20px;">开发</a></li> <li><a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a></li>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于Android</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Zous</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img lazy-src="/img/head.png" class="js-avatar">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Zous</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:nimdanoob@163.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/nimdanoob" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-pattern-proxy" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/post/pattern-proxy.html" class="article-date">
      <time datetime="2016-01-21T13:41:33.000Z" itemprop="datePublished">2016-01-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/pattern-proxy.html">设计模式之代理模式</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="u4EE3_u7406_u6A21_u5F0F_u7684_u6982_u5FF5"><a href="#u4EE3_u7406_u6A21_u5F0F_u7684_u6982_u5FF5" class="headerlink" title="代理模式的概念"></a><strong>代理模式的概念</strong></h1><p>　　<strong>代理模式（proxy pattern）</strong>是一种结构型的设计模式，代理模式在程序开发中的运用非常广泛。简单地描述代理模式就是：<strong>为其他对象（被代理对象）提供一种代理以控制对原有对象的操作。实际的行为是由被代理对象完成的</strong>。<br>　　代理模式可以分为两部分，<strong>静态代理</strong> 和 <strong>动态代</strong>理，它们的区别将在下面详细介绍。</p>
<h2 id="u89D2_u8272_u4ECB_u7ECD_uFF1A"><a href="#u89D2_u8272_u4ECB_u7ECD_uFF1A" class="headerlink" title="角色介绍："></a><strong>角色介绍</strong>：</h2><p>　　<strong>Suject： 抽象主题类</strong><br>　　该类的主要职责是申明真是主题与代理的共同接口方法，该类既可以是个抽象类也可以是个接口（具有抽象方法）。<br>　　<strong>RealSubject: 真实主题类</strong><br>　　该类也称为委托类或者被代理类，改类定义了代理所表示的真是对象（也就是实现了抽象方法），由其执行具体的业务逻辑。<br>　　<strong>ProxySubject：代理类</strong><br>　　这个类的对象持有一个对真实主题的引用，在这个类所实现的接口方法中调用真实主题类中相应的方法执行，这样就实现了代理的目的。<br>　　<strong>Client：客户类</strong><br>　　也就是使用代理类的类型，客户类通过代理类间接地调用了真实主题类中定义的方法。</p>
<h1 id="u4EE3_u7406_u6A21_u5F0F_u7684_u5B9E_u73B0"><a href="#u4EE3_u7406_u6A21_u5F0F_u7684_u5B9E_u73B0" class="headerlink" title="代理模式的实现"></a><strong>代理模式的实现</strong></h1><h2 id="u7B80_u5355_u7684_u4F8B_u5B50"><a href="#u7B80_u5355_u7684_u4F8B_u5B50" class="headerlink" title="简单的例子"></a><strong>简单的例子</strong></h2><p>  针对，上方的角色介绍，举一个简单的例子：在现实的世界中，打公司一般有，原告 和原告的代理律师这样两个角色，他们要做的事情是 辩护。于是，我们可以实现以下几个类。<br>  抽象主题类：interface IDefender,这个接口中有个 抽象方法 abstract public void defend(); 表示辩护这个行为。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDefender</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defend</span>(<span class="params"></span>)</span>;<span class="comment">//辩护行为</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  真实主题类: class Accuser，实现IDefender这个接口，具有具体的逻辑行为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Accuser</span> <span class="keyword">implements</span> <span class="title">IDefender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"被告严重侵犯了公民的人身自由权...哔哩哔哩"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  代理类：AccuserProxy 类，原告请了个代理律师帮助它打官司，也就是AccuserProxy，由代理律师控制原告的表现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccuserProxy</span> <span class="keyword">implements</span> <span class="title">IDefender</span> </span>&#123;</span><br><span class="line">    <span class="comment">//持有被代理类的引用</span></span><br><span class="line">    <span class="keyword">private</span> IDefender iDefend;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccuserProxy</span><span class="params">(IDefender iDefend)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iDefend = iDefend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        beforeDefend();</span><br><span class="line">        <span class="comment">// 被代理类的行为</span></span><br><span class="line">        iDefend.defend();</span><br><span class="line">        afterDefend();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修饰的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">beforeDefend</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.print(<span class="string">"我是原告律师，以下是我方辩词"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修饰的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span>   <span class="keyword">void</span> <span class="title">afterDefend</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.print(<span class="string">"辩护完毕"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 客户端：Client类，使用代理类的角色<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Client</span> &#123;</span></span><br><span class="line">    public static void main(<span class="constant">String</span>[] args) &#123;</span><br><span class="line">        <span class="constant">Accuser</span> accuser = new <span class="constant">Accuser</span>();</span><br><span class="line">        accuser.defend();<span class="regexp">//</span>此时输出 被告严重侵犯了公民的人身自由权...哔哩哔哩</span><br><span class="line"></span><br><span class="line">        <span class="constant">AccuserProxy</span> accuserProxy = new <span class="constant">AccuserProxy</span>(accuser);</span><br><span class="line">        accuserProxy.defend();</span><br><span class="line">        <span class="regexp">//</span> 输出：我是原告律师，以下是我方辩词，被告严重侵犯了公民的人身自由权...哔哩哔哩，辩护完毕</span><br><span class="line"></span><br><span class="line">        /<span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span></span><br><span class="line">        /<span class="regexp">/ 因为，我们的代理类和被代理类 实现的是同一接口，如果将引用类型 写成IDfender,</span><br><span class="line">        /</span><span class="regexp">/ 那么在调用 defend()，方法的使用 客户完全感觉不到被代理类的存在，当然因为我们这里的</span><br><span class="line">        /</span><span class="regexp">/ 被代理类是通过构造函数传进去的，软件开发中，有时候直接在被代理类中实例化代理类，这样使用起来就更完美了。</span><br><span class="line">        IDefender accuser2 = new Accuser();</span><br><span class="line">        IDefender accuser2Proxy = new AccuserProxy(accuser2);</span><br><span class="line">        </span><br><span class="line">        accuser2.defend();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>　　代理模式的运用符合开闭原则的定义，软件中的对象（类、模块、函数）应该对于拓展是开发的，对于修改是封闭的。我们不需要修改被代理类 （Accuser），使用代理模式就可以实现对原有功能的加强。以上代码只是一个简答的运用场景，现实开发中代理模式的运用非常广泛，它可以解决多方面的问题。</p>
<h2 id="Androd__u5F00_u53D1_u4E2D_u7684_u8FD0_u7528_u4F8B_u5B50"><a href="#Androd__u5F00_u53D1_u4E2D_u7684_u8FD0_u7528_u4F8B_u5B50" class="headerlink" title="Androd 开发中的运用例子"></a><strong>Androd 开发中的运用例子</strong></h2><p>　　Android API的版本迭代很快，在每次的版本更新中 通常会加强一些原有的功能，对原有的类会增加新的接口，而每个版本能够调用的API 可能会都不同，比如 状态栏 <strong>Notification</strong> 。</p>
<blockquote>
<p>Notfification可以分为4类，一类是正常视图，也就是我们通常在状态栏看到的 高度为 64dp 的长条状通知视图；一类是在 API16 中引入的以 Style 方式展示的 <strong>MediaStyle</strong>、<strong>InboxStyle</strong>、<strong>BigTextStyle</strong> 和 <strong>BigPictureStyle</strong> 四种Notification 风格样式;一类也是在 API16 中引入的可以将通知视图显示为256dp 高度大视图的 <strong>bingContentView</strong>；最后一类是在 L 中引入的 <strong>headsUpContentVIew</strong></p>
</blockquote>
<p>　　现在，我们的 App需要根据不同的版本实例化不同 Notification 显示不同的视图，在高版本显示的视图当然就更丰富，低版本更单调。如果你直接在 Activity 中判断版本，加上一坨的 switch 或者 if else 语句当然也是可以的。但是，我们现在来看一下 运用设计模式的思想，如何将代码抽离，对于客户端来说(Activity or Fragment)，不应该关心这些细节。<br>以下的代码来自<strong>《Android源码设计模式解析与实战》</strong>一书。</p>
<p>抽象主题类： Notify类， Notify抽象类 声明了 NotificationManager 和NotificatoinCompat.Builder 2个成员变量来处理和通知的一些逻辑。在构造函数中初始化所有子类都会调用的逻辑方法。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Notify</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> Context context;</span><br><span class="line">    <span class="keyword">protected</span> NotificationManager nm;</span><br><span class="line">    <span class="keyword">protected</span> NotificationCompat.Builder builder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Notify</span>(<span class="params">Context context</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        nm = (NotificationManager)context.getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">        builder = <span class="keyword">new</span> NotificationCompat.Builder(context);</span><br><span class="line">        builder.setSmallIcon(R.mipmap.ic_launcher)</span><br><span class="line">                .setContentIntent(PendingIntent.getActivities(</span><br><span class="line">                        context,</span><br><span class="line">                        <span class="number">0</span>,</span><br><span class="line">                        <span class="keyword">new</span> Intent[]&#123;<span class="keyword">new</span> Intent(context, NotifyActivity.class)&#125;,</span><br><span class="line">                        PendingIntent.FLAG_UPDATE_CURRENT));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 发送一条通知</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">send</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 取消一条通知</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">cancel</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>真实主题类：NotifyNormal ，继承抽象主题类，简单重写抽象方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifyNormal</span> <span class="keyword">extends</span> <span class="title">Notify</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NotifyNormal</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Notification n = builder.build();</span><br><span class="line">        n.contentView = <span class="keyword">new</span> RemoteViews(context.getPackageName(),</span><br><span class="line">                R.layout.remote_notify_proxy_normal);</span><br><span class="line">        nm.notify(<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nm.cancel(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>真实主题类 : 与NormalNotify的不同在于 还实现了bigContentView 的初始化，这是在 API 16以上才能调用的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifyBig</span> <span class="keyword">extends</span> <span class="title">Notify</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NotifyBig</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@TargetApi</span>(Build.VERSION_CODES.JELLY_BEAN)</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Notification n = builder.build();</span><br><span class="line">        n.contentView = <span class="keyword">new</span> RemoteViews(context.getPackageName(), R.layout.remote_notify_proxy_normal);</span><br><span class="line">        n.bigContentView = <span class="keyword">new</span> RemoteViews(context.getPackageName(),R.layout.remote_notify_proxy_big);</span><br><span class="line">        nm.notify(<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nm.cancel(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　源码中还有个 NotifyHeadUp 类，它的唯一区别就是 在bigContentVie 的基础上还能实现 Notification 的 <strong>headsUpContentView</strong> ，这个 View 是在 API 20以上 才能使用的，当我们的 App 以全屏的方式展开的时候如果收到了通知，这个 View 就会浮动展示于屏幕顶部。</p>
<p>　　代理类: NotifyProxy ,持有被代理类对象，在这个示例中，我们根据不同的运行时环境 API 实例化不同的 被代理类对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifyProxy</span> <span class="keyword">extends</span> <span class="title">Notify</span></span>&#123;</span><br><span class="line">    <span class="comment">//代理类持有被代理类的引用</span></span><br><span class="line">    <span class="keyword">private</span> Notify notify;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NotifyProxy</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        <span class="comment">//根据版本实例化不同的被代理对象</span></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP)&#123;</span><br><span class="line">            notify = <span class="keyword">new</span> NotifyHeadUp(context);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT)&#123;</span><br><span class="line">            notify = <span class="keyword">new</span> NotifyBig(context);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            notify = <span class="keyword">new</span> NotifyNormal(context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        notify.send();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        notify.cancel();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　客户端类：也就是我们的Activity,在 Activity 中，我们直接将 Context 传入，代理类会帮我们实例化合适的被代理对象。<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> NotifyProxy(NotifyActivity.<span class="keyword">this</span>).send();</span><br></pre></td></tr></table></figure></p>
<p>　　在这个实例中，我们通过代理模式 ，使用一个代理类来针对不同的运行时系统版本，实例化不同的 Notificaition 的子类，而在客户端中 简单地调用代理类的send方法就可以。</p>
<h2 id="u9759_u6001_u4EE3_u7406_u6A21_u5F0F_u603B_u7ED3"><a href="#u9759_u6001_u4EE3_u7406_u6A21_u5F0F_u603B_u7ED3" class="headerlink" title="静态代理模式总结"></a><strong>静态代理模式总结</strong></h2><p>　　代理模式通过代理类对外部提供统一的接口，在代理类中实现对被代理类的附加操作，从而可以在不影响外部调用的情况下实现系统的拓展，我觉得代理模式可能在一个程序项目的开发初期运用不到，而在项目成型而又有了新的变化、升级等，可以考虑用代理模式来实现，这样可以不需要修改原有的代码。</p>
<h1 id="u52A8_u6001_u4EE3_u7406_u6A21_u5F0F"><a href="#u52A8_u6001_u4EE3_u7406_u6A21_u5F0F" class="headerlink" title="动态代理模式"></a><strong>动态代理模式</strong></h1><p>　　其实上文所讲述的内容只是代理模式的一部分，代理模式还有更为强大的动态代理模式。以下是这 2 个的区别：</p>
<blockquote>
<p>静态代理模式：在我们的代码运行前，代理类的class编译文件就已经存在了<br>动态代理模式：在 code 阶段并不存在被代理类，而且并不知道要代理哪个对象，利用 Java 的反射机制在运行期动态地生成代理者的对象，代理谁将会在代码执行阶段决定。</p>
</blockquote>
<h2 id="u52A8_u6001_u4EE3_u7406_u6A21_u5F0F_u7684_u5B9E_u73B0"><a href="#u52A8_u6001_u4EE3_u7406_u6A21_u5F0F_u7684_u5B9E_u73B0" class="headerlink" title="动态代理模式的实现"></a><strong>动态代理模式的实现</strong></h2><p>　　Java 已经为我们提供了一个便捷的动态代理接口 <strong>InvocationHandler</strong> ,我们重写其调用方法 invoke。以前面 我们的代理律师的例子为例，看看具体的操作是怎么样的<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class <span class="type">DynamicProxy</span> implements <span class="type">InvocationHandler</span>&#123;</span><br><span class="line">    private <span class="type">Object</span> <span class="keyword">object</span>;// 被代理类的类引用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public <span class="type">DynamicProxy</span>(<span class="type">Object</span> <span class="keyword">object</span>) &#123;</span><br><span class="line">        this.<span class="keyword">object</span> = <span class="keyword">object</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">Object</span> invoke(<span class="type">Object</span> proxy, <span class="type">Method</span> <span class="keyword">method</span>, <span class="type">Object</span>[] args) throws <span class="type">Throwable</span> &#123;</span><br><span class="line">        beforeDefend();</span><br><span class="line">        //调用被代理类对象的方法</span><br><span class="line">        <span class="type">Object</span> <span class="literal">result</span> = <span class="keyword">method</span>.invoke(<span class="keyword">object</span>, args);</span><br><span class="line">        afterDefend();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="type">void</span> beforeDefend()&#123;</span><br><span class="line">        <span class="type">System</span>.<span class="keyword">out</span>.print(<span class="string">"我是原告律师，以下是我方辩词"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    private   <span class="type">void</span> afterDefend()&#123;</span><br><span class="line">        <span class="type">System</span>.<span class="keyword">out</span>.print(<span class="string">"辩护完毕"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　解释一下这个 invoke 方法，我们通过 invoke 方法来调用具体的被代理方法，也就是真实的方法，如果对反射机制了解的话， <strong>method.invoke(object,args)</strong> 这句代码应该很好理解，<strong>object</strong> 是被代理类，<strong>method</strong> 是被代理类的方法，<strong>args</strong> 是方法的参数。</p>
<p>　　我们仅仅是实现了 InvocationHandler 的接口，那么接下来该做什么呢？怎么实现动态生成代理者对象呢？Java 的 java.lang.reflect 包下 还有一个 Proxy 类，它有个静态方法 newProxyInstance（），我们使用这个方法生成。以前面 我们的代理律师的例子为例，<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) &#123;</span><br><span class="line">        <span class="comment">//被代理类</span></span><br><span class="line">        IDefender accuser = <span class="keyword">new</span> Accuser();</span><br><span class="line">        accuser.defend();</span><br><span class="line"></span><br><span class="line">        DynamicProxy proxy = <span class="keyword">new</span> DynamicProxy(accuser);</span><br><span class="line">        ClassLoader loader = accuser.getClass().getClassLoader();</span><br><span class="line">        IDefender proxyIDefender = (IDefender) Proxy.newProxyInstance(loader, <span class="keyword">new</span> Class[]&#123;IDefender.<span class="keyword">class</span>&#125;, proxy);</span><br><span class="line"></span><br><span class="line">        proxyIDefender.defend();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　这个客户端的输出结果，和之前是一样的,可以发现，我们将之前代理类的工作，转换到 <strong>InvocationHandler</strong> 的 invoke() 方法去执行，不再需要关心到底需要代理谁。</p>
<h2 id="u52A8_u6001_u4EE3_u7406_u5728_Retrofit__u6846_u67B6_u4E2D_u7684_u8FD0_u7528"><a href="#u52A8_u6001_u4EE3_u7406_u5728_Retrofit__u6846_u67B6_u4E2D_u7684_u8FD0_u7528" class="headerlink" title="动态代理在 Retrofit 框架中的运用"></a>动态代理在 Retrofit 框架中的运用</h2><p>　　<a href="https://realm.io/cn/news/droidcon-jake-wharton-simple-http-retrofit-2/" target="_blank" rel="external">Retrofit</a> 是 Android 上流行的 Http Client请求库先看以下一段代码<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">interface</span> <span class="tag">GitHubService</span> &#123;</span><br><span class="line">  <span class="variable">@GET</span>(<span class="string">"/repos/&#123;owner&#125;/&#123;repo&#125;/contributors"</span>)</span><br><span class="line">  List&lt;Contributor&gt; <span class="function">repoContributors</span>(</span><br><span class="line">      <span class="variable">@Path</span>(<span class="string">"owner"</span>) String owner,</span><br><span class="line">      <span class="variable">@Path</span>(<span class="string">"repo"</span>) String repo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">    .baseUrl(<span class="string">"https://api.github.com"</span>)</span><br><span class="line">    .build();</span><br><span class="line"><span class="comment">//代理模式的运用</span></span><br><span class="line">GitHubService service = retrofit.create(GitHubService.<span class="keyword">class</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">Call</span>&lt;<span class="keyword">List</span>&lt;Repo&gt;&gt; repos = service.repoContributors(<span class="string">"owner"</span>,<span class="string">"repo"</span>);</span></span><br></pre></td></tr></table></figure>
<p>　　由于我们要研究的方向是动态代理模式，所以我们直接深入主题，看一下这段代码</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GitHubService service = retrofit.<span class="keyword">create</span>(GitHubService.<span class="keyword">class</span>);</span><br></pre></td></tr></table></figure>
<p>　　GitHubService 是个接口，它作为Retrofit.create()方法的参数传入，这个方法的调用的返回对象 是个  GitHubService 的实例，那么它是怎么实现的呢？以下是 create()方法的代码，看没看到 <strong>Proxy.newProxyInstance()</strong> ,和 <strong>InvocationHandler()</strong>。同样，在这里 Retrofit 通过 注解 和 动态代理，用户只需要使用 注解 作用在抽象方法和抽象方法的参数上申明，这些 注解、方法参数、 方法返回值类型就提供了一次网络请求所需的信息，而具体的操作是由Retrofit通过解析这些信息，在运行期生成代理对象去调用。<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">　　public &lt;T&gt; T create(final <span class="type">Class</span>&lt;T&gt; service) &#123;</span><br><span class="line">  <span class="type">Utils</span>.validateServiceInterface(service);</span><br><span class="line">  <span class="keyword">if</span> (validateEagerly) &#123;</span><br><span class="line">    eagerlyValidateMethods(service);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (T) <span class="type">Proxy</span>.newProxyInstance(service.getClassLoader(), new <span class="type">Class</span>&lt;?&gt;[] &#123; service &#125;,</span><br><span class="line">      new <span class="type">InvocationHandler</span>() &#123;</span><br><span class="line">        private final <span class="type">Platform</span> platform = <span class="type">Platform</span>.get();</span><br><span class="line"></span><br><span class="line">        @<span class="type">Override</span> public <span class="type">Object</span> invoke(<span class="type">Object</span> proxy, <span class="type">Method</span> <span class="keyword">method</span>, <span class="type">Object</span>... args)</span><br><span class="line">            throws <span class="type">Throwable</span> &#123;</span><br><span class="line">          // <span class="type">If</span> the <span class="keyword">method</span> <span class="keyword">is</span> a <span class="keyword">method</span> <span class="keyword">from</span> <span class="type">Object</span> then defer to normal invocation.</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">method</span>.getDeclaringClass() == <span class="type">Object</span>.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">method</span>.invoke(this, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (platform.isDefaultMethod(<span class="keyword">method</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> platform.invokeDefaultMethod(<span class="keyword">method</span>, service, proxy, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> loadMethodHandler(<span class="keyword">method</span>).invoke(args);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　</p>
<h2 id="u52A8_u6001_u4EE3_u7406_u6A21_u5F0F_u603B_u7ED3"><a href="#u52A8_u6001_u4EE3_u7406_u6A21_u5F0F_u603B_u7ED3" class="headerlink" title="动态代理模式总结"></a>动态代理模式总结</h2><p>　　动态代理模式在代码的运行阶段才生成 代理类对象，动态代理模式运用在需要对访问做特殊处理，比如对某个方法的调用加入权限验证；或者是对原来的方法进行统一的拓展，比如加入日志记录等，代理模式还被运用在实现 AOP ，大家可以去了解一下。<br>　　<br>　　本文参考 ：<a href="http://a.codekk.com/detail/Android/Caij/%E5%85%AC%E5%85%B1%E6%8A%80%E6%9C%AF%E7%82%B9%E4%B9%8B%20Java%20%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86" target="_blank" rel="external">codekk-公共技术点之动态代理</a>
　　       </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/android/">android</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-reproduced-bitmap-size-analysis" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/post/reproduced-bitmap-size-analysis.html" class="article-date">
      <time datetime="2016-01-20T02:28:00.003Z" itemprop="datePublished">2016-01-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/reproduced-bitmap-size-analysis.html">Bitmap到底占多少内存</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><strong>出处“腾讯Bugly(<a href="http://bugly.qq.com" target="_blank" rel="external">http://bugly.qq.com</a>)</strong><br><strong>0、写在前面</strong></p>
<p>本文涉及到屏幕密度的讨论，这里先要搞清楚 DisplayMetrics 的两个变量，摘录官方文档的解释：</p>
<ul>
<li>density：The logical density of the display. This is a scaling factor for the Density Independent Pixel unit, where one DIP is one pixel on an approximately 160 dpi screen (for example a 240x320, 1.5”x2” screen), providing the baseline of the system’s display. Thus on a 160dpi screen this density value will be 1; on a 120 dpi screen it would be .75; etc.</li>
</ul>
<p>This value does not exactly follow the real screen size (as given by xdpi and ydpi, but rather is used to scale the size of the overall UI in steps based on gross changes in the display dpi. For example, a 240x320 screen will have a density of 1 even if its width is 1.8”, 1.3”, etc. However, if the screen resolution is increased to 320x480 but the screen size remained 1.5”x2” then the density would be increased (probably to 1.5).</p>
<ul>
<li>densityDpi：The screen density expressed as dots-per-inch.</li>
</ul>
<p>简单来说，可以理解为 density 的数值是 1dp=density px；densityDpi 是屏幕每英寸对应多少个点（不是像素点），在 DisplayMetrics 当中，这两个的关系是线性的：<br>| density  | 1   |  1.5  | 2 | 3 | 3.5 | 4 |<br>| ——   | —–:  | :—-:  |:—-:  |:—-:  |:—-:  |<br>| densityDpi  | 160   |  240  | 320 | 480 | 560 | 640 |</p>
<p>为了不引起混淆，本文所有提到的密度除非特别说明，都指的是 densityDpi，当然如果你愿意，也可以用 density 来说明问题。</p>
<p>另外，本文的依据主要来自 android 5.0 的源码，其他版本可能略有出入。文章难免疏漏，欢迎指正～</p>
<h1 id="1_u3001_u5360_u4E86_u591A_u5927_u5185_u5B58_uFF1F"><a href="#1_u3001_u5360_u4E86_u591A_u5927_u5185_u5B58_uFF1F" class="headerlink" title="1、占了多大内存？"></a><strong>1、占了多大内存？</strong></h1><p>做移动客户端开发的朋友们肯定都因为图头疼过，说起来曾经还有过 leader 因为组里面一哥们在工程里面加了一张 jpg 的图发脾气的事儿，哈哈。</p>
<p>为什么头疼呢？吃内存呗，时不时还给你来个 OOM 冲冲喜，让你的每一天过得有滋有味（真是没救了）。那每次工程里面增加一张图片的时候，我们都需要关心这货究竟要占多大的坑，占多大呢？Android API 有个方便的方法，<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public final <span class="type">int</span> getByteCount() &#123;</span><br><span class="line">    // <span class="type">int</span> <span class="literal">result</span> permits bitmaps up to <span class="number">46</span>,<span class="number">340</span> x <span class="number">46</span>,<span class="number">340</span></span><br><span class="line">    <span class="keyword">return</span> getRowBytes() * getHeight();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过这个方法，我们就可以获取到一张 Bitmap 在运行时到底占用多大内存了。</p>
<hr>
<p>##举个例子##</p>
<p>一张 <strong>522x686</strong> 的 <strong>PNG</strong> 图片，我把它放到 <strong>drawable-xxhdpi</strong> 目录下，在<strong>三星s6</strong>上加载，占用内存<strong>2547360B</strong>，就可以用这个方法获取到。</p>
<hr>
<h1 id="2_u3001_u7ED9_u6211_u4E00_u5F20_u56FE_u6211_u544A_u8BC9_u4F60_u5360_u591A_u5927_u5185_u5B58"><a href="#2_u3001_u7ED9_u6211_u4E00_u5F20_u56FE_u6211_u544A_u8BC9_u4F60_u5360_u591A_u5927_u5185_u5B58" class="headerlink" title="2、给我一张图我告诉你占多大内存"></a><strong>2、给我一张图我告诉你占多大内存</strong></h1><p>每次都问 Bitmap 你到底多大啦。。感觉怪怪的，毕竟我们不能总是去问，而不去搞清楚它为嘛介么大吧。能不能给它算个命，算算它究竟多大呢？当然是可以的，很简单嘛，我们直接顺藤摸瓜，找出真凶，哦不，找出答案。</p>
<h2 id="2-1_getByteCount"><a href="#2-1_getByteCount" class="headerlink" title="2.1 getByteCount"></a><strong>2.1 getByteCount</strong></h2><p>getByteCount 的源码我们刚刚已经认识了，当我们问 Bitmap 大小的时候，这孩子也是先拿到出生年月日，然后算出来的，那么问题来了，getHeight 就是图片的高度（单位：px），getRowBytes 是什么？</p>
<pre><code>public final int getrowBytes() {
   if (mRecycled) {
          Log.w(TAG, &quot;Called getRowBytes() on a recycle()&apos;d bitmap! This is undefined behavior!&quot;);
   }
   return nativeRowBytes(mFinalizer.mNativeBitmap);
}
</code></pre><p>额，感觉太对了啊，要 JNI 了。由于在下 C++ 实在用得少，每次想起 JNI 都请想象脑门磕墙的场景，不过呢，毛爷爷说过，一切反动派都是纸老虎~与 nativeRowBytes 对应的函数如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Bitmap.<span class="function">cpp</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jint <span class="title">Bitmap_rowBytes</span><span class="params">(JNIEnv* env, jobject, jlong bitmapHandle)</span> </span>&#123;</span><br><span class="line">         SkBitmap* bitmap = <span class="keyword">reinterpret_cast</span>&lt;SkBitmap*&gt;(bitmapHandle)</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;jint&gt;(bitmap-&gt;rowBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>等等，我们好像发现了什么，原来 Bitmap 本质上就是一个 SkBitmap。。而这个 SkBitmap 也是大有来头，不信你瞧：Skia。啥也别说了，赶紧瞅瞅 SkBitmap。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">SkBitmap.h</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Return the number of bytes between subsequent rows of the bitmap. */</span></span><br><span class="line"><span class="keyword">size_t</span> rowBytes() <span class="keyword">const</span> &#123; <span class="keyword">return</span> fRowBytes; &#125;</span><br><span class="line">SkBitmap.cpp</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> SkBitmap::ComputeRowBytes(Config c, <span class="keyword">int</span> width) &#123;</span><br><span class="line">    <span class="keyword">return</span> SkColorTypeMinRowBytes(SkBitmapConfigToColorType(c), width);</span><br><span class="line"> &#125;</span><br><span class="line">SkImageInfo.<span class="function">h</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">SkColorTypeBytesPerPixel</span><span class="params">(SkColorType ct)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint8_t</span> gSize[] = &#123;</span><br><span class="line">    <span class="number">0</span>,  <span class="comment">// Unknown</span></span><br><span class="line">    <span class="number">1</span>,  <span class="comment">// Alpha_8</span></span><br><span class="line">    <span class="number">2</span>,  <span class="comment">// RGB_565</span></span><br><span class="line">    <span class="number">2</span>,  <span class="comment">// ARGB_4444</span></span><br><span class="line">    <span class="number">4</span>,  <span class="comment">// RGBA_8888</span></span><br><span class="line">    <span class="number">4</span>,  <span class="comment">// BGRA_8888</span></span><br><span class="line">    <span class="number">1</span>,  <span class="comment">// kIndex_8</span></span><br><span class="line">  &#125;;</span><br><span class="line">  SK_COMPILE_ASSERT(SK_ARRAY_COUNT(gSize) == (<span class="keyword">size_t</span>)(kLastEnum_SkColorType + <span class="number">1</span>),</span><br><span class="line">                size_mismatch_with_SkColorType_enum);</span><br><span class="line"></span><br><span class="line">   SkASSERT((<span class="keyword">size_t</span>)ct &lt; SK_ARRAY_COUNT(gSize));</span><br><span class="line">   <span class="keyword">return</span> gSize[ct];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> size_t <span class="title">SkColorTypeMinRowBytes</span><span class="params">(SkColorType ct, <span class="keyword">int</span> width)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">width * <span class="title">SkColorTypeBytesPerPixel</span><span class="params">(ct)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好，跟踪到这里，我们发现 ARGB_8888（也就是我们最常用的 Bitmap 的格式）的一个像素占用 4byte，那么 rowBytes 实际上就是 4*width bytes。</p>
<p>那么结论出来了，一张 ARGB_8888 的 Bitmap 占用内存的计算公式</p>
<p><strong>bitmapInRam = bitmapWidth<em>bitmapHeight </em>4 bytes</strong></p>
<p>说到这儿你以为故事就结束了么？有本事你拿去试，算出来的和你获取到的总是会差个倍数，为啥呢？</p>
<p>还记得我们最开始给出的那个例子么？</p>
<p>一张<strong>522*686</strong>的 <strong>PNG</strong> 图片，我把它放到 <strong>drawable-xxhdpi</strong> 目录下，在<strong>三星s6</strong>上加载，占用内存<strong>2547360B</strong>，就可以用这个方法获取到。</p>
<p>然而公式计算出来的可是1<strong>432368B</strong>。。。</p>
<h2 id="2-2_Density"><a href="#2-2_Density" class="headerlink" title="2.2 Density"></a>2.2 <strong>Density</strong></h2><p>知道我为什么在举例的时候那么费劲的说放到xxx目录下，还要说用xxx手机么？你以为 Bitmap 加载只跟宽高有关么？Naive。</p>
<p>还是先看代码，我们读取的是 drawable 目录下面的图片，用的是 decodeResource 方法，该方法本质上就两步：</p>
<p>读取原始资源，这个调用了 <strong>Resource.openRawResource</strong> 方法，这个方法调用完成之后会对 TypedValue 进行赋值，其中包含了原始资源的 density 等信息；<br>调用 decodeResourceStream 对原始资源进行解码和适配。这个过程实际上就是原始资源的 density 到屏幕 density 的一个映射。<br>原始资源的 density 其实取决于资源存放的目录（比如 xxhdpi 对应的是480），而屏幕 density 的赋值，请看下面这段代码：</p>
<p><strong>BitmapFactory.java</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeResourceStream</span>(<span class="params">Resources res, TypedValue <span class="keyword">value</span>,</span><br><span class="line">    InputStream <span class="keyword">is</span>, Rect pad, Options opts</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实际上，我们这里的opts是null的，所以在这里初始化。</span></span><br><span class="line"><span class="keyword">if</span> (opts == <span class="keyword">null</span>) &#123;</span><br><span class="line">    opts = <span class="keyword">new</span> Options();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (opts.inDensity == <span class="number">0</span> &amp;&amp; <span class="keyword">value</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">    final <span class="keyword">int</span> density = <span class="keyword">value</span>.density;</span><br><span class="line">    <span class="keyword">if</span> (density == TypedValue.DENSITY_DEFAULT) &#123;</span><br><span class="line">        opts.inDensity = DisplayMetrics.DENSITY_DEFAULT;</span><br><span class="line">    &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">density != TypedValue.DENSITY_NONE</span>) </span>&#123;</span><br><span class="line">        opts.inDensity = density; <span class="comment">//这里density的值如果对应资源目录为hdpi的话，就是240</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (opts.inTargetDensity == <span class="number">0</span> &amp;&amp; res != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//请注意，inTargetDensity就是当前的显示密度，比如三星s6时就是640</span></span><br><span class="line">    opts.inTargetDensity = res.getDisplayMetrics().densityDpi;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> decodeStream(<span class="keyword">is</span>, pad, opts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到 opts 这个值被初始化，而它的构造居然如此简单：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">public</span> Options() &#123;</span><br><span class="line">   <span class="title">inDither</span> = <span class="built_in">false</span>;</span><br><span class="line">   <span class="title">inScaled</span> = <span class="built_in">true</span>;</span><br><span class="line">   <span class="title">inPremultiplied</span> = <span class="built_in">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以我们就很容易的看到，Option.inScreenDensity 这个值没有被初始化，而实际上后面我们也会看到这个值根本不会用到；我们最应该关心的是什么呢？是 inDensity 和 inTargetDensity，这两个值与下面 cpp 文件里面的 density 和 targetDensity 相对应——重复一下，inDensity 就是原始资源的 density，inTargetDensity 就是屏幕的 density。</p>
<p>紧接着，用到了 nativeDecodeStream 方法，不重要的代码直接略过，直接给出最关键的 doDecode 函数的代码：</p>
<p><strong>BitmapFactory.cpp</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jobject <span class="title">doDecode</span><span class="params">(JNIEnv* env, SkStreamRewindable* stream, jobject padding, jobject options)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">    <span class="keyword">if</span> (env-&gt;GetBooleanField(options, gOptions_scaledFieldID)) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> density = env-&gt;GetIntField(options, gOptions_densityFieldID);<span class="comment">//对应hdpi的时候，是240</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> targetDensity = env-&gt;GetIntField(options, gOptions_targetDensityFieldID);<span class="comment">//三星s6的为640</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> screenDensity = env-&gt;GetIntField(options, gOptions_screenDensityFieldID);</span><br><span class="line">        <span class="keyword">if</span> (density != <span class="number">0</span> &amp;&amp; targetDensity != <span class="number">0</span> &amp;&amp; density != screenDensity) &#123;</span><br><span class="line">            scale = (<span class="keyword">float</span>) targetDensity / density;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> willScale = scale != <span class="number">1.0f</span>;</span><br><span class="line">......</span><br><span class="line">SkBitmap decodingBitmap;</span><br><span class="line"><span class="keyword">if</span> (!decoder-&gt;decode(stream, &amp;decodingBitmap, prefColorType,decodeMode)) &#123;</span><br><span class="line">   <span class="keyword">return</span> nullObjectReturn(<span class="string">"decoder-&gt;decode returned false"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这里这个deodingBitmap就是解码出来的bitmap，大小是图片原始的大小</span></span><br><span class="line"><span class="keyword">int</span> scaledWidth = decodingBitmap.width();</span><br><span class="line"><span class="keyword">int</span> scaledHeight = decodingBitmap.height();</span><br><span class="line"><span class="keyword">if</span> (willScale &amp;&amp; decodeMode != SkImageDecoder::kDecodeBounds_Mode) &#123;</span><br><span class="line">    scaledWidth = <span class="keyword">int</span>(scaledWidth * scale + <span class="number">0.5f</span>);</span><br><span class="line">    scaledHeight = <span class="keyword">int</span>(scaledHeight * scale + <span class="number">0.5f</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (willScale) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">float</span> sx = scaledWidth / <span class="keyword">float</span>(decodingBitmap.width());</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">float</span> sy = scaledHeight / <span class="keyword">float</span>(decodingBitmap.height());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> avoid copying when scaled size equals decodingBitmap size</span></span><br><span class="line">    SkColorType colorType = colorTypeForScaledOutput(decodingBitmap.colorType());</span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> If the alphaType is kUnpremul and the image has alpha, the</span></span><br><span class="line">    <span class="comment">// colors may not be correct, since Skia does not yet support drawing</span></span><br><span class="line">    <span class="comment">// to/from unpremultiplied bitmaps.</span></span><br><span class="line">    outputBitmap-&gt;setInfo(SkImageInfo::Make(scaledWidth, scaledHeight,</span><br><span class="line">            colorType, decodingBitmap.alphaType()));</span><br><span class="line">    <span class="keyword">if</span> (!outputBitmap-&gt;allocPixels(outputAllocator, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> nullObjectReturn(<span class="string">"allocation failed for scaled bitmap"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If outputBitmap's pixels are newly allocated by Java, there is no need</span></span><br><span class="line">    <span class="comment">// to erase to 0, since the pixels were initialized to 0.</span></span><br><span class="line">    <span class="keyword">if</span> (outputAllocator != &amp;javaAllocator) &#123;</span><br><span class="line">        outputBitmap-&gt;eraseColor(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SkPaint paint;</span><br><span class="line">    paint.setFilterLevel(SkPaint::kLow_FilterLevel);</span><br><span class="line"></span><br><span class="line">    <span class="function">SkCanvas <span class="title">canvas</span><span class="params">(*outputBitmap)</span></span>;</span><br><span class="line">    canvas.scale(sx, sy);</span><br><span class="line">    canvas.drawBitmap(decodingBitmap, <span class="number">0.0f</span>, <span class="number">0.0f</span>, &amp;paint);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意到其中有个 density 和 targetDensity，前者是 decodingBitmap 的 density，这个值跟这张图片的放置的目录有关（比如 hdpi 是240，xxhdpi 是480），这部分代码我跟了一下，太长了，就不列出来了；targetDensity 实际上是我们加载图片的目标 density，这个值的来源我们已经在前面给出了，就是 DisplayMetrics 的 densityDpi，如果是三星s6那么这个数值就是640。sx 和sy 实际上是约等于 scale 的，因为 scaledWidth 和 scaledHeight 是由 width 和 height 乘以 scale 得到的。我们看到 Canvas 放大了 scale 倍，然后又把读到内存的这张 bitmap 画上去，相当于把这张 bitmap 放大了 scale 倍。</p>
<p>再来看我们的例子：</p>
<p>一张522*686的PNG 图片，我把它放到 drawable-xxhdpi 目录下，在三星s6上加载，占用内存2547360B，其中 density 对应 xxhdpi 为480，targetDensity 对应三星s6的密度为640：</p>
<p>522/480 <em> 640 </em> 686/480  <em>640 </em> 4 = 2546432B</p>
<h2 id="2-3__u7CBE_u5EA6"><a href="#2-3__u7CBE_u5EA6" class="headerlink" title="2.3 精度"></a><strong>2.3 精度</strong></h2><p>越来越有趣了是不是，你肯定会发现我们这么细致的计算还是跟获取到的数值</p>
<p><strong>不！一！样！</strong></p>
<p>为什么呢？由于结果已经非常接近，我们很自然地想到精度问题。来，再把上面这段代码中的一句拿出来看看：</p>
<pre><code>outputBitmap-&gt;setInfo(SkImageInfo::Make(scaledWidth, scaledHeight,
            colorType, decodingBitmap.alphaType()));
</code></pre><p>我们看到最终输出的 outputBitmap 的大小是scaledWidth*scaledHeight，我们把这两个变量计算的片段拿出来给大家一看就明白了：</p>
<pre><code>if (willScale &amp;&amp; decodeMode != SkImageDecoder::kDecodeBounds_Mode) {
    scaledWidth = int(scaledWidth * scale + 0.5f);
    scaledHeight = int(scaledHeight * scale + 0.5f);
}
</code></pre><p>在我们的例子中，</p>
<p>scaledWidth = int( 522 * 640 / 480f + 0.5) = int(696.5) = 696</p>
<p>scaledHeight = int( 686 * 640 / 480f + 0.5) = int(915.16666…) = 915</p>
<p>下面就是见证奇迹的时刻：</p>
<p><strong>915  <em> 696 </em>  4 = 2547360</strong></p>
<p>有木有很兴奋！有木有很激动！！</p>
<p>写到这里，突然想起《STL源码剖析》一书的扉页，侯捷先生只写了一句话：</p>
<blockquote>
<p>“源码之前，了无秘密”。</p>
</blockquote>
<h2 id="2-4__u5C0F_u7ED3"><a href="#2-4__u5C0F_u7ED3" class="headerlink" title="2.4 小结"></a><strong>2.4 小结</strong></h2><p>其实，通过前面的代码跟踪，我们就不难知道，Bitmap 在内存当中占用的大小其实取决于：</p>
<ul>
<li>色彩格式，前面我们已经提到，如果是 ARGB8888 那么就是一个像素4个字节，如果是 RGB565 那就是2个字节</li>
<li>原始文件存放的资源目录（是 hdpi 还是 xxhdpi 可不能傻傻分不清楚哈）</li>
<li>目标屏幕的密度（所以同等条件下，红米在资源方面消耗的内存肯定是要小于三星S6的）</li>
</ul>
<h1 id="3_u3001_u60F3_u529E_u6CD5_u51CF_u5C11_Bitmap__u5185_u5B58_u5360_u7528"><a href="#3_u3001_u60F3_u529E_u6CD5_u51CF_u5C11_Bitmap__u5185_u5B58_u5360_u7528" class="headerlink" title="3、想办法减少 Bitmap 内存占用"></a><strong>3、想办法减少 Bitmap 内存占用</strong></h1><h2 id="3-1_Jpg__u548C_Png"><a href="#3-1_Jpg__u548C_Png" class="headerlink" title="3.1 Jpg 和 Png"></a><strong>3.1 Jpg 和 Png</strong></h2><p>说到这里，肯定会有人会说，我们用 jpg 吧，jpg 格式的图片不应该比 png 小么？</p>
<p>这确实是个好问题，因为同样一张图片，jpg 确实比 png 会多少小一些（甚至很多），原因很简单，jpg 是一种<strong>有损压缩</strong>的图片存储格式，而 png 则是 <strong>无损压缩</strong>的图片存储格式，显而易见，<strong>jpg 会比 png 小，代价也是显而易见的。</strong></p>
<p>可是，这说的是文件存储范畴的事情，<strong>它们只存在于文件系统，而非内存或者显存</strong>。说得简单一点儿，我有一个极品飞车的免安装硬盘版的压缩包放在我的磁盘里面，这个游戏是不能玩的，我需要先解压，才能玩——jpg 也好，png 也好就是个压缩包的概念，而我们讨论的<strong>内存占用则是从使用角度来讨论的</strong>。</p>
<p>所以，jpg 格式的图片与 png 格式的图片在内存当中不应该有什么不同。</p>
<blockquote>
<p>『啪！！！』</p>
<p>『谁这么缺德！！打人不打脸好么！』</p>
</blockquote>
<p>肯定有人有意见，jpg 图片读到内存就是会小，还会给我拿出例子。当然，他说的不一定是错的。因为 j<strong>pg 的图片没有 alpha 通道</strong>！！所以读到内存的时候如果用 RGB565的格式存到内存，这下大小只有 ARGB8888的一半，能不小么。。。</p>
<p>不过，抛开 Android 这个平台不谈，从出图的角度来看的话，jpg 格式的图片大小也不一定比 png 的小，这要取决于图像信息的内容：</p>
<blockquote>
<p>JPG 不适用于所含颜色很少、具有大块颜色相近的区域或亮度差异十分明显的较简单的图片。对于需要高保真的较复杂的图像，PNG 虽然能无损压缩，但图片文件较大。</p>
</blockquote>
<p>如果仅仅是为了 Bitmap 读到内存中的大小而考虑的话，jpg 也好 png 也好，没有什么实质的差别；二者的差别主要体现在：</p>
<ul>
<li>alpha 你是否真的需要？如果需要 alpha 通道，那么没有别的选择，用 png。</li>
<li>你的图色值丰富还是单调？就像刚才提到的，如果色值丰富，那么用jpg，如果作为按钮的背景，请用 png。</li>
<li>对安装包大小的要求是否非常严格？如果你的 app 资源很少，安装包大小问题不是很凸显，看情况选择 jpg 或者 png（不过，我想现在对资源文件没有苛求的应用会很少吧。。）</li>
<li>目标用户的 cpu 是否强劲？jpg 的图像压缩算法比 png 耗时。这方面还是要酌情选择，前几年做了一段时间 Cocos2dx，由于资源非常多，项目组要求统一使用 png，可能就是出于这方面的考虑。</li>
</ul>
<p>嗯，跑题了，我们其实想说的是怎么减少内存占用的。。这一小节只是想说，休想通过这个方法来减少内存占用。。。XD</p>
<h2 id="3-2__u4F7F_u7528_inSampleSize"><a href="#3-2__u4F7F_u7528_inSampleSize" class="headerlink" title="3.2 使用 inSampleSize"></a><strong>3.2 使用 inSampleSize</strong></h2><p>有些朋友一看到这个肯定就笑了。采样嘛，我以前是学信号处理的，一看到 Sample 就抽抽。。哈哈开个玩笑，这个采样其实就跟统计学里面的采样是一样的，在保证最终效果满足要求的前提下减少样本规模，方便后续的数据采集和处理。</p>
<p>这个方法主要用在图片资源本身较大，或者适当地采样并不会影响视觉效果的条件下，这时候我们输出地目标可能相对较小，对图片分辨率、大小要求不是非常的严格。</p>
<hr>
<p>举个例子</p>
<p>我们现在有个需求，要求将一张图片进行模糊，然后作为 ImageView 的 src 呈现给用户，而我们的原始图片大小为 1080*1920，如果我们直接拿来模糊的话，一方面模糊的过程费时费力，另一方面生成的图片又占用内存，实际上在模糊运算过程中可能会存在输入和输出并存的情况，此时内存将会有一个短暂的峰值。</p>
<p>这时候你一定会想到三个字母在你的脑海里挥之不去，它们就是『OOM』。</p>
<p>既然图片最终是要被模糊的，也看不太情况，还不如直接用一张采样后的图片，如果<strong>采样率为 2</strong>，那么读出来的图片只有<strong>原始图片的 1/4</strong> 大小，真是何乐而不为呢？？</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BitmapFactory.<span class="keyword">Options</span> <span class="keyword">options</span> = <span class="keyword">new</span> <span class="keyword">Options</span>();</span><br><span class="line"><span class="keyword">options</span>.inSampleSize = <span class="number">2</span>;</span><br><span class="line">Bitmap bitmap = BitmapFactory.decodeResource(getResources(), resId, <span class="keyword">options</span>);</span><br></pre></td></tr></table></figure>
<h2 id="3-3__u4F7F_u7528_u77E9_u9635"><a href="#3-3__u4F7F_u7528_u77E9_u9635" class="headerlink" title="3.3 使用矩阵"></a><strong>3.3 使用矩阵</strong></h2><p>用到 Bitmap 的地方，总会见到 Matrix。这时候你会想到什么？</p>
<blockquote>
<p>『基友』</p>
<p>『是在下输了。。』</p>
</blockquote>
<p>其实想想，Bitmap 的像素点阵，还不就是个矩阵，真是你中有我，我中有你的交情啊。那么什么时候用矩阵呢？</p>
<p><strong>大图小用用采样，小图大用用矩阵。</strong></p>
<p>还是用前面模糊图片的例子，我们不是采样了么？内存是小了，可是图的尺寸也小了啊，我要用 Canvas 绘制这张图可怎么办？当然是用矩阵了：</p>
<h3 id="u65B9_u5F0F_u4E00_uFF1A"><a href="#u65B9_u5F0F_u4E00_uFF1A" class="headerlink" title="方式一："></a><strong>方式一：</strong></h3><p>Matrix matrix = new Matrix();<br>matrix.preScale(2, 2, 0f, 0f);<br>//如果使用直接替换矩阵的话，在Nexus6 5.1.1上必须关闭硬件加速<br>canvas.concat(matrix);<br>canvas.drawBitmap(bitmap, 0,0, paint);<br>需要注意的是，在使用搭载 5.1.1 原生系统的 Nexus6 进行测试时发现，如果使用 Canvas 的 setMatrix 方法，可能会导致与矩阵相关的元素的绘制存在问题，本例当中如果使用 setMatrix 方法，bitmap 将不会出现在屏幕上。因此请尽量使用 canvas 的 scale、rotate 这样的方法，或者使用 concat 方法。</p>
<h3 id="u65B9_u5F0F_u4E8C_uFF1A"><a href="#u65B9_u5F0F_u4E8C_uFF1A" class="headerlink" title="方式二："></a><strong>方式二</strong>：</h3><p>Matrix matrix = new Matrix();<br>matrix.preScale(2, 2, 0, 0);<br>canvas.drawBitmap(bitmap, matrix, paint);<br>这样，绘制出来的图就是放大以后的效果了，不过占用的内存却仍然是我们采样出来的大小。</p>
<p>如果我要把图片放到 ImageView 当中呢？一样可以，请看：</p>
<p>Matrix matrix = new Matrix();<br>matrix.postScale(2, 2, 0, 0);<br>imageView.setImageMatrix(matrix);<br>imageView.setScaleType(ScaleType.MATRIX);<br>imageView.setImageBitmap(bitmap);</p>
<h2 id="3-4__u5408_u7406_u9009_u62E9Bitmap_u7684_u50CF_u7D20_u683C_u5F0F"><a href="#3-4__u5408_u7406_u9009_u62E9Bitmap_u7684_u50CF_u7D20_u683C_u5F0F" class="headerlink" title="3.4 合理选择Bitmap的像素格式"></a><strong>3.4 合理选择Bitmap的像素格式</strong></h2><p>其实前面我们已经多次提到这个问题。ARGB8888格式的图片，每像素占用 4 Byte，而 RGB565则是 2 Byte。我们先看下有多少种格式可选：<br>| 格式 | 描述   |<br>| -   | :  |<br>| ALPH_8 | 只有一个alpha通道 |<br>| ARGB_4444 | 这个从API 13开始不建议使用，因为质量太差 |<br>| ARGB_8888 | ARGB四个通道，每个通道8bit |<br>| RGB_565 | 每个像素占2Byte，其中红色占5bit，绿色占6bit，蓝色占5bit |</p>
<p>这几个当中，</p>
<p><strong>ALPHA8</strong> 没必要用，因为我们随便用个颜色就可以搞定的。</p>
<p><strong>ARGB4444</strong> 虽然占用内存只有 <strong>ARGB8888</strong> 的一半，不过已经被官方嫌弃，失宠了。。『又要占省内存，又要看着爽，臣妾做不到啊T T』。</p>
<p><strong>ARGB8888</strong> 是最常用的，大家应该最熟悉了。</p>
<p><strong>RGB565</strong> 看到这个，我就看到了资源优化配置无处不在，这个绿色。。（不行了，突然好邪恶XD），其实如果不需要 alpha 通道，特别是资源本身为 jpg 格式的情况下，用这个格式比较理想。</p>
<h2 id="3-5__u9AD8_u80FD_uFF1A_u7D22_u5F15_u4F4D_u56FE_28Indexed_Bitmap_29"><a href="#3-5__u9AD8_u80FD_uFF1A_u7D22_u5F15_u4F4D_u56FE_28Indexed_Bitmap_29" class="headerlink" title="3.5 高能：索引位图(Indexed Bitmap)"></a><strong>3.5 高能：索引位图(Indexed Bitmap)</strong></h2><p>索引位图，每个像素只占 1 Byte，不仅支持 RGB，还支持 alpha，而且看上去效果还不错！等等，请收起你的口水，Android 官方并不支持这个。是的，你没看错，官方并不支持。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> public <span class="class"><span class="keyword">enum</span> <span class="title">Config</span> &#123;</span></span><br><span class="line">    /<span class="regexp">/ these native values must match up with the enum in SkBitmap.h</span><br><span class="line"></span><br><span class="line">    ALPHA_8     (2),</span><br><span class="line">    RGB_565     (4),</span><br><span class="line">    ARGB_4444   (5),</span><br><span class="line">    ARGB_8888   (6);</span><br><span class="line"></span><br><span class="line">    final int nativeInt;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>不过，Skia 引擎是支持的，不信你再看：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Config</span> &#123;</span></span><br><span class="line">   kNo_Config,   <span class="regexp">//</span>!&lt; bitmap has not been configured</span><br><span class="line">     kA8_Config,   <span class="regexp">//</span>!&lt; <span class="number">8</span>-bits per pixel, <span class="keyword">with</span> only alpha specified (<span class="number">0</span> is transparent, <span class="number">0xFF</span> is opaque)</span><br><span class="line"></span><br><span class="line">   /<span class="regexp">/看这里看这里！！↓↓↓↓↓</span><br><span class="line">    kIndex8_Config, /</span><span class="regexp">/!&lt; 8-bits per pixel, using SkColorTable to specify the colors  </span><br><span class="line">    kRGB_565_Config, /</span><span class="regexp">/!&lt; 16-bits per pixel, (see SkColorPriv.h for packing)</span><br><span class="line">    kARGB_4444_Config, /</span><span class="regexp">/!&lt; 16-bits per pixel, (see SkColorPriv.h for packing)</span><br><span class="line">    kARGB_8888_Config, /</span><span class="regexp">/!&lt; 32-bits per pixel, (see SkColorPriv.h for packing)</span><br><span class="line">    kRLE_Index8_Config,</span><br><span class="line"></span><br><span class="line">    kConfigCount</span><br><span class="line">&#125;;</span></span><br></pre></td></tr></table></figure></p>
<p>其实 Java 层的枚举变量的 nativeInt 对应的就是 Skia 库当中枚举的索引值，所以，如果我们能够拿到这个索引是不是就可以了？对不起，拿不到。</p>
<p>不行了，废话这么多，肯定要挨板砖了T T。</p>
<p>不过呢，在 png 的解码库里面有这么一段代码：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">bool</span> SkPNGImageDecoder::getBitmapColorType(png_structp png_ptr, png_infop info_ptr,</span><br><span class="line">                                       SkColorType* colorTypep,</span><br><span class="line">                                       <span class="keyword">bool</span>* hasAlphap,</span><br><span class="line">                                       SkPMColor* SK_RESTRICT theTranspColorp) &#123;</span><br><span class="line">png_uint_32 origWidth, origHeight;</span><br><span class="line"><span class="keyword">int</span> bitDepth, colorType;</span><br><span class="line">png_get_IHDR(png_ptr, info_ptr, &amp;origWidth, &amp;origHeight, &amp;bitDepth,</span><br><span class="line">             &amp;colorType, int_p_NULL, int_p_NULL, int_p_NULL);</span><br><span class="line"></span><br><span class="line"><span class="comment">#ifdef PNG_sBIT_SUPPORTED</span></span><br><span class="line">  <span class="comment">// check for sBIT chunk data, in case we should disable dithering because</span></span><br><span class="line">  <span class="comment">// our data is not truely 8bits per component</span></span><br><span class="line">  png_color_8p sig_bit;</span><br><span class="line">  <span class="keyword">if</span> (this-&gt;getDitherImage() &amp;&amp; png_get_sBIT(png_ptr, info_ptr, &amp;sig_bit)) &#123;</span><br><span class="line"><span class="comment">#if 0</span></span><br><span class="line">    SkDebugf(<span class="string">"----- sBIT %d %d %d %d\n"</span>, sig_bit-&gt;red, sig_bit-&gt;green,</span><br><span class="line">             sig_bit-&gt;blue, sig_bit-&gt;alpha);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">    <span class="comment">// 0 seems to indicate no information available</span></span><br><span class="line">    <span class="keyword">if</span> (pos_le(sig_bit-&gt;red, SK_R16_BITS) &amp;&amp;</span><br><span class="line">        pos_le(sig_bit-&gt;green, SK_G16_BITS) &amp;&amp;</span><br><span class="line">        pos_le(sig_bit-&gt;blue, SK_B16_BITS)) &#123;</span><br><span class="line">        this-&gt;setDitherImage(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (colorType == PNG_COLOR_TYPE_PALETTE) &#123;</span><br><span class="line">    <span class="keyword">bool</span> paletteHasAlpha = hasTransparencyInPalette(png_ptr, info_ptr);</span><br><span class="line">    *colorTypep = this-&gt;getPrefColorType(kIndex_SrcDepth, paletteHasAlpha);</span><br><span class="line">    <span class="comment">// now see if we can upscale to their requested colortype</span></span><br><span class="line">    <span class="comment">//这段代码，如果返回false，那么colorType就被置为索引了，那么我们看看如何返回false</span></span><br><span class="line">    <span class="keyword">if</span> (!canUpscalePaletteToConfig(*colorTypep, paletteHasAlpha)) &#123;</span><br><span class="line">        *colorTypep = kIndex_8_SkColorType;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">...... </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">canUpscalePaletteToConfig函数如果返回<span class="keyword">false</span>，那么colorType就被置为kIndex_8_SkColorType了。</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> canUpscalePaletteToConfig(SkColorType dstColorType, <span class="keyword">bool</span> srcHasAlpha) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (dstColorType) &#123;</span><br><span class="line">    <span class="keyword">case</span> kN32_SkColorType:</span><br><span class="line">    <span class="keyword">case</span> kARGB_4444_SkColorType:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">case</span> kRGB_565_SkColorType:</span><br><span class="line">        <span class="comment">// only return true if the src is opaque (since 565 is opaque)</span></span><br><span class="line">        <span class="keyword">return</span> !srcHasAlpha;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果传入的 <strong>dstColorType</strong> 是 <strong>kRGB_565_SkColorType</strong>，同时图片还有 alpha 通道，那么返回 false~~咳咳，那么问题来了，<strong>这个dstColorType</strong> 是哪儿来的？？就是我们在 decode 的时候，传入的 Options 的 <strong>inPreferredConfig</strong>。</p>
<hr>
<p>下面是实验时间~</p>
<p><strong>准备</strong>：在 assets 目录当中放了一个叫 index.png 的文件，大小192*192，这个文件是通过 PhotoShop 编辑之后生成的索引格式的图片。</p>
<p><strong>代码</strong>：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="keyword">Options</span> <span class="keyword">options</span> = <span class="keyword">new</span> <span class="keyword">Options</span>();</span><br><span class="line">   <span class="keyword">options</span>.inPreferredConfig = Config.RGB_565;</span><br><span class="line">Bitmap bitmap = BitmapFactory.decodeStream(getResources().getAssets().open(<span class="string">"index.png"</span>), <span class="keyword">null</span>, <span class="keyword">options</span>);</span><br><span class="line">   Log.d(TAG, <span class="string">"bitmap.getConfig() = "</span> + bitmap.getConfig());</span><br><span class="line">   Log.d(TAG, <span class="string">"scaled bitmap.getByteCount() = "</span> + bitmap.getByteCount());</span><br><span class="line">   imageView.setImageBitmap(bitmap);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序运行在 Nexus6上，由于从 assets 中读取不涉及前面讨论到的 scale 的问题，所以这张图片读到内存以后的大小理论值（ARGB8888）：<br><strong>192 <em> 192  </em>4=147456</strong></p>
<p>好，运行我们的代码，看输出的 Config 和 ByteCount：</p>
<p>D/MainActivity: bitmap.getConfig() = null<br>D/MainActivity: scaled bitmap.getByteCount() = 36864<br>先说大小为什么只有 36864，我们知道如果前面的讨论是没有问题的话，那么这次解码出来的 Bitmap 应该是索引格式，那么占用的内存只有 <strong>ARGB 8888</strong> 的1/4是意料之中的；再说 Config 为什么为 null。。额。。黑户。。官方说：</p>
<p>public final Bitmap.Config getConfig ()</p>
<p>Added in API level 1</p>
<p>If the bitmap’s internal config is in one of the public formats, return that config, otherwise return null.</p>
<p>再说一遍，黑户。。XD。</p>
<p>看来这个法子还真行啊，占用内存一下小很多。不过由于官方并未做出支持，因此这个方法有诸多限制，比如不能在 xml 中直接配置，，生成的 Bitmap 不能用于构建 Canvas 等等。</p>
<h2 id="3-6__u6BCF_u4E2A_u50CF_u7D20_u53602Byte_uFF0C_u5176_u4E2D_u7EA2_u8272_u53605bit_uFF0C_u7EFF_u8272_u53606bit_uFF0C_u84DD_u8272_u53605bit"><a href="#3-6__u6BCF_u4E2A_u50CF_u7D20_u53602Byte_uFF0C_u5176_u4E2D_u7EA2_u8272_u53605bit_uFF0C_u7EFF_u8272_u53606bit_uFF0C_u84DD_u8272_u53605bit" class="headerlink" title="3.6 每个像素占2Byte，其中红色占5bit，绿色占6bit，蓝色占5bit"></a><strong>3.6 每个像素占2Byte，其中红色占5bit，绿色占6bit，蓝色占5bit</strong></h2><p>其实我们一直在抱怨资源大，有时候有些场景其实不需要图片也能完成的。比如在开发中我们会经常遇到 Loading，这些 Loading 通常就是几帧图片，图片也比较简单，只需要黑白灰加 alpha 就齐了。</p>
<blockquote>
<p>『排期太紧了，这些给我出一系列图吧』</p>
<p>『好，不过每张图都是 300*30 0的 png 哈，总共 5 张，为了适配不同的分辨率，需要出 xxhdpi 和 xxxhdpi 的两套图。。』</p>
</blockquote>
<p>Orz。。。</p>
<p>如果是这样，你还是自定义一个 View，覆写 onDraw 自己画一下好了。。。</p>
<h1 id="4_u3001_u7ED3_u8BED"><a href="#4_u3001_u7ED3_u8BED" class="headerlink" title="4、结语"></a><strong>4、结语</strong></h1><p>写了这么多，我们来稍稍理一理，本文主要讨论了如何运行时获取 Bitmap 占用内存的大小，如果事先根据 Bitmap 的格式、读取方式等算出其占用内存的大小，后面又整理了一些常见的 Bitmap 使用建议。突然好像说，是时候研究一下 Skia 引擎了。</p>
<p>怎么办，看来扔了好几年的 C++还是要捡回来么。。噗。。。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/转载/">转载</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bitmap/">-bitmap</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-android-activity-analytical" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/post/android-activity-analytical.html" class="article-date">
      <time datetime="2016-01-18T11:15:08.000Z" itemprop="datePublished">2016-01-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/android-activity-analytical.html">Activity详解</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Activity_u7684_u751F_u547D_u5468_u671F"><a href="#Activity_u7684_u751F_u547D_u5468_u671F" class="headerlink" title="Activity的生命周期"></a><strong>Activity的生命周期</strong></h1><h2 id="Activity_u7684_u751F_u547D_u5468_u671F_u6D41_u7A0B"><a href="#Activity_u7684_u751F_u547D_u5468_u671F_u6D41_u7A0B" class="headerlink" title="Activity的生命周期流程"></a><strong>Activity的生命周期流程</strong></h2><p>在正常情况下，一个 Activity 的生命周期流程可以由下图表示<br><img src="http://7xq84c.com1.z0.glb.clouddn.com/android-activity-lifecycle.gif" alt="Activity生命周期图"></p>
<ol>
<li>onCreate: Activity正在被创建，可以理解为一个Activity的入口。在这个方法中，我们通常会通过调用 setContentView (int res) 或者 setContentView(Viewview) 来设置显示的视图，之后调用findviewById来初始化一些视图成员。</li>
<li>onStart: Activity正在被启动，处于这个生命周期的 Activity 还处于后台，是一个可见不可交互的状态，(你可以尝试在这个生命周期中sleep几秒，看看你能看到什么)。</li>
<li>onResume: Activity被置于前台，是一个可见可交互的状态。在这个方法被回调的时候，一个Activity可以被用户所正常操作</li>
<li>onPause: Activity 正在被停止，一般情况下接下来就回调onStop函数，注意的是这个方法中不应该执行耗时操作，如果是启动另外一个Activity，只有这个回调方法被调用了，被启动的 Activity 才能正常的被显示在前台。</li>
<li>onStop: Activity 即将停止，这个方法调用完后，并不一定会马上调用 onDestory，在这个Activity长时间没有被使用（回到这个Activity）或者是用户主动销毁才会调用 onDestory。</li>
<li>onDestory: Activity 正在被销毁，这是一个Activity生命周期的最后一个回调函数，在这个方法中，我们一般做一些最终的回收工作。注意的是onDestory被调用并不意味着这个Activity实例被销毁了（Java对象层面上）。</li>
<li>onRestart: Activity 没有被 Destory，处于不可见的状态，用户要重新回到这个 Activity 时，直接调用 onRestart 方法，重新启动Activity。</li>
</ol>
<h2 id="u4E00_u4E9B_u7279_u6B8A_u60C5_u51B5"><a href="#u4E00_u4E9B_u7279_u6B8A_u60C5_u51B5" class="headerlink" title="一些特殊情况"></a>一些特殊情况</h2><p>(1)如果打开一个新 Activity，这个新的Activity使用的是透明主题，那么旧Activity的onStop方法不会被调用<br>(2) 非standard启动模式的 Activity，Activity被复用时会调用onNewIntent()</p>
<h1 id="Activity_u7684__u542F_u52A8_u6A21_u5F0F_u4E0E_u4EFB_u52A1_u6808"><a href="#Activity_u7684__u542F_u52A8_u6A21_u5F0F_u4E0E_u4EFB_u52A1_u6808" class="headerlink" title="Activity的 启动模式与任务栈"></a><strong>Activity的 启动模式与任务栈</strong></h1><blockquote>
<p>Android提供了4种启动模式</p>
</blockquote>
<p>　　分别是 standard、singleTop、singleTask、singleInstance。<br>在描述以上4个启动模式时，先来理清楚<strong>任务栈</strong>，TaskAffinity描述了一个Activity所需要的任务栈，TaskAffinity 是一个 String 类型的变量，一个 Activity 默认的 TaskAffinity 是应用的包名，当然也可以在 AndroidManifest 自定义Activity所需要的任务栈，不过必须也是包名的形式。</p>
<blockquote>
<ol>
<li>standard: 标准模式，系统的默认模式，在一个任务栈中可以由多个该Activity的实例，即startActivity()方法会多次创建 Activity 的实例。在这种模式下，谁启动了这个 Activity，这个 Activity 就在谁的任务栈中，比如A 启动了 standard 模式的任务栈B，那么B就在A的任务栈中<br><br><br></li>
<li>singletop: 栈顶复用模式，在一个任务栈中，如果栈顶已经存在了这个Activity，那么不会创建新的Activity,而且旧的Activity也不会重新调用生命周期函数。<br><br><br></li>
<li>singleTask: 栈内复用模式，和栈顶模式不同的是，只要在一个栈中存在，就会复用，如果不是在栈顶，是在栈顶一下，就会讲它以上的 Activity 弹出栈，使其位于栈顶显示。这里需要注意一个 Activity 所需的任务栈的概念，比如S1栈中为AB,这时候如果启动一个 singleTask 模式的 Activity C,且所需的任务栈为 S2 ,这时候回先创建任务栈，再创建C并放入S2中<br><br><br></li>
<li>singleInstance: 单实例模式，启动这种任务栈模式的Activity时，会创建一个新的任务栈，这时这个任务栈中只能有这个Activity，也有栈内复用的特性。可以看做是加强的singleTask。<br><br><br></li>
</ol>
</blockquote>
<p>   在不是标准模式的启动模式的Activity，复用 Activity会调用 Activity 的 onNewIntent()方法。</p>
<h1 id="Activity_u7684_u72B6_u6001_u4FDD_u5B58"><a href="#Activity_u7684_u72B6_u6001_u4FDD_u5B58" class="headerlink" title="Activity的状态保存"></a><strong>Activity的状态保存</strong></h1><h2 id="u5982_u4F55_u5B9E_u73B0_u72B6_u6001_u4FDD_u5B58"><a href="#u5982_u4F55_u5B9E_u73B0_u72B6_u6001_u4FDD_u5B58" class="headerlink" title="如何实现状态保存"></a><strong>如何实现状态保存</strong></h2><p>　　Android 系统考虑到Activity在异常情况下被杀死重建（资源相关的系统配置发生改变或者是由于内存不足优先级低的Activity被杀死），为了能很好的重建被杀死之前的操作视图，提供了 onSaveInstanceState(Bundle) 和 onRestoreInstance(Bundle) 2个回调方法，我们可以在 onSaveInstanceState(Bundle) 方法中给方法提供的参数 onSaveInstanceState(Bundle) 方法中给方法提供的 Bundle 参数赋值。当Activity重建时就可以在 onSavaInstanceState(Bundle) 中获得保存的值，进行操作。注意的是，系统已经默认为我们操作了一些数据视图的保存和重建，比如 EditText 的文本，光标的位置等等。这是因为每个View其实都有自己的重建回复功能，每个 View 都有 onSaveInstanceState() 和 onRestoreInstanceState(Parcelable) 方法， Activiy 在保存和重建时，会调用所有 contentView 子View 的响应保存重建状态的方法。</p>
<h2 id="onSaveInstanceState_28Bundle_29_u65B9_u6CD5_u7684_u8C03_u7528_u65F6_u673A"><a href="#onSaveInstanceState_28Bundle_29_u65B9_u6CD5_u7684_u8C03_u7528_u65F6_u673A" class="headerlink" title="onSaveInstanceState(Bundle)方法的调用时机"></a><strong>onSaveInstanceState(Bundle)方法的调用时机</strong></h2><p>　　<strong>onSaveInstanceState(Bundle)是在可能被杀死的情况下就会被调用</strong>，如果这个方法被调用肯定是在onStop之前调用，不过和onPause没有时序关系，既可能在之前也可能在之后。</p>
<h2 id="onCreate_28Bundle_29onRestoreInstanceState_28Bundle_29_u7684_u533A_u522B"><a href="#onCreate_28Bundle_29onRestoreInstanceState_28Bundle_29_u7684_u533A_u522B" class="headerlink" title="onCreate(Bundle)onRestoreInstanceState(Bundle)的区别"></a><strong>onCreate(Bundle)onRestoreInstanceState(Bundle)的区别</strong></h2><p>　　这两个方法都能获得 BundlesavedInstanceState ,不同的是 onRestoreInstanceState(Bundle) 方法只有在 Bundle 不为空的时候才会被回调，所以在这里面可以不用判断空值的情况，一定是有值的，onStart(Bundle) 方法则需要判空。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/android/">android</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/activity/">activity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-tests" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/post/tests.html" class="article-date">
      <time datetime="2016-01-17T08:41:33.000Z" itemprop="datePublished">2016-01-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/tests.html">tests</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/android/">android</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-china-md" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/post/china-md.html" class="article-date">
      <time datetime="2016-01-17T08:41:33.000Z" itemprop="datePublished">2016-01-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/china-md.html">中国文案排版指南</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="u4E2D_u6587_u6587_u6848_u6392_u7248_u6307_u5317"><a href="#u4E2D_u6587_u6587_u6848_u6392_u7248_u6307_u5317" class="headerlink" title="中文文案排版指北"></a>中文文案排版指北</h1><p><a href="https://david-dm.org/mzlogin/chinese-copywriting-guidelines#info=devDependencies" target="_blank" rel="external"><img src="https://david-dm.org/mzlogin/chinese-copywriting-guidelines/dev-status.svg" alt="devDependency Status"></a></p>
<p>统一中文文案、排版的相关用法，降低团队成员之间的沟通成本，增强网站气质。</p>
<p>Other languages:</p>
<ul>
<li><a href="/README.en.md">English</a></li>
<li><a href="https://github.com/sparanoid/chinese-copywriting-guidelines" target="_blank" rel="external">Chinese Traditional</a></li>
<li><a href="/README.md">Chinese Simplified</a></li>
</ul>
<hr>
<h2 id="u76EE_u5F55"><a href="#u76EE_u5F55" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="/#空格">空格</a><ul>
<li><a href="/#中英文之间需要增加空格">中英文之间需要增加空格</a></li>
<li><a href="/#中文与数字之间需要增加空格">中文与数字之间需要增加空格</a></li>
<li><a href="/#数字与单位之间需要增加空格">数字与单位之间需要增加空格</a></li>
<li><a href="/#全角标点与其他字符之间不加空格">全角标点与其他字符之间不加空格</a></li>
<li><a href="/#-ms-text-autospace-to-the-rescue"><code>-ms-text-autospace</code> to the rescue?</a></li>
</ul>
</li>
<li><a href="/#标点符号">标点符号</a><ul>
<li><a href="/#不重复使用标点符号">不重复使用标点符号</a></li>
</ul>
</li>
<li><a href="/#全角和半角">全角和半角</a><ul>
<li><a href="/#使用全角中文标点">使用全角中文标点</a></li>
<li><a href="/#数字使用半角字符">数字使用半角字符</a></li>
<li><a href="/#遇到完整的英文整句特殊名词其內容使用半角标点">遇到完整的英文整句、特殊名词，其內容使用半角标点</a></li>
</ul>
</li>
<li><a href="/#名词">名词</a><ul>
<li><a href="/#专有名词使用正确的大小写">专有名词使用正确的大小写</a></li>
<li><a href="/#不要使用不地道的缩写">不要使用不地道的缩写</a></li>
</ul>
</li>
<li><a href="/#争议">争议</a><ul>
<li><a href="/#链接之间增加空格">链接之间增加空格</a></li>
<li><a href="/#简体中文使用直角引号">简体中文使用直角引号</a></li>
</ul>
</li>
<li><a href="/#工具">工具</a></li>
<li><a href="/#谁在这样做">谁在这样做？</a></li>
<li><a href="/#参考文献">参考文献</a></li>
</ul>
<h2 id="u7A7A_u683C"><a href="#u7A7A_u683C" class="headerlink" title="空格"></a>空格</h2><p>「有研究显示，打字的时候不喜欢在中文和英文之间加空格的人，感情路都走得很辛苦，有七成的比例会在 34 岁的时候跟自己不爱的人结婚，而其余三成的人最后只能把遗产留给自己的猫。毕竟爱情跟书写都需要适时地留白。</p>
<p>与大家共勉之。」——<a href="https://github.com/vinta/paranoid-auto-spacing" target="_blank" rel="external">vinta/paranoid-auto-spacing</a></p>
<h3 id="u4E2D_u82F1_u6587_u4E4B_u95F4_u9700_u8981_u589E_u52A0_u7A7A_u683C"><a href="#u4E2D_u82F1_u6587_u4E4B_u95F4_u9700_u8981_u589E_u52A0_u7A7A_u683C" class="headerlink" title="中英文之间需要增加空格"></a>中英文之间需要增加空格</h3><p>正确：</p>
<blockquote>
<p>在 LeanCloud 上，数据存储是围绕 <code>AVObject</code> 进行的。</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>在LeanCloud上，数据存储是围绕<code>AVObject</code>进行的。</p>
<p>在 LeanCloud上，数据存储是围绕<code>AVObject</code> 进行的。</p>
</blockquote>
<p>完整的正确用法：</p>
<blockquote>
<p>在 LeanCloud 上，数据存储是围绕 <code>AVObject</code> 进行的。每个 <code>AVObject</code> 都包含了与 JSON 兼容的 key-value 对应的数据。数据是 schema-free 的，你不需要在每个 <code>AVObject</code> 上提前指定存在哪些键，只要直接设定对应的 key-value 即可。</p>
</blockquote>
<p>例外：「豆瓣FM」等产品名词，按照官方所定义的格式书写。</p>
<h3 id="u4E2D_u6587_u4E0E_u6570_u5B57_u4E4B_u95F4_u9700_u8981_u589E_u52A0_u7A7A_u683C"><a href="#u4E2D_u6587_u4E0E_u6570_u5B57_u4E4B_u95F4_u9700_u8981_u589E_u52A0_u7A7A_u683C" class="headerlink" title="中文与数字之间需要增加空格"></a>中文与数字之间需要增加空格</h3><p>正确：</p>
<blockquote>
<p>今天出去买菜花了 5000 元。</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>今天出去买菜花了 5000元。</p>
<p>今天出去买菜花了5000元。</p>
</blockquote>
<h3 id="u6570_u5B57_u4E0E_u5355_u4F4D_u4E4B_u95F4_u9700_u8981_u589E_u52A0_u7A7A_u683C"><a href="#u6570_u5B57_u4E0E_u5355_u4F4D_u4E4B_u95F4_u9700_u8981_u589E_u52A0_u7A7A_u683C" class="headerlink" title="数字与单位之间需要增加空格"></a>数字与单位之间需要增加空格</h3><p>正确：</p>
<blockquote>
<p>我家的光纤入户宽带有 10 Gbps，SSD 一共有 20 TB。</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>我家的光纤入户宽带有 10Gbps，SSD 一共有 10TB。</p>
</blockquote>
<p>例外：度／百分比与数字之间不需要增加空格：</p>
<p>正确：</p>
<blockquote>
<p>今天是 233° 的高温。</p>
<p>新 MacBook Pro 有 15% 的 CPU 性能提升。</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>今天是 233 ° 的高温。</p>
<p>新 MacBook Pro 有 15 % 的 CPU 性能提升。</p>
</blockquote>
<h3 id="u5168_u89D2_u6807_u70B9_u4E0E_u5176_u4ED6_u5B57_u7B26_u4E4B_u95F4_u4E0D_u52A0_u7A7A_u683C"><a href="#u5168_u89D2_u6807_u70B9_u4E0E_u5176_u4ED6_u5B57_u7B26_u4E4B_u95F4_u4E0D_u52A0_u7A7A_u683C" class="headerlink" title="全角标点与其他字符之间不加空格"></a>全角标点与其他字符之间不加空格</h3><p>正确：</p>
<blockquote>
<p>刚刚买了一部 iPhone，好开心！</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>刚刚买了一部 iPhone ，好开心！</p>
</blockquote>
<h3 id="ms-text-autospace_to_the_rescue_3F"><a href="#ms-text-autospace_to_the_rescue_3F" class="headerlink" title="-ms-text-autospace to the rescue?"></a><code>-ms-text-autospace</code> to the rescue?</h3><p>Microsoft 有个 <a href="http://msdn.microsoft.com/en-us/library/ie/ms531164(v=vs.85" target="_blank" rel="external"><code>-ms-text-autospace</code></a>.aspx) 的 CSS 属性可以实现自动为中英文之间增加空白。不过目前并未普及，另外在其他应用场景，例如 OS X、iOS 的用户界面目前并不存在这个特性，所以请继续保持随手加空格的习惯。</p>
<h2 id="u6807_u70B9_u7B26_u53F7"><a href="#u6807_u70B9_u7B26_u53F7" class="headerlink" title="标点符号"></a>标点符号</h2><h3 id="u4E0D_u91CD_u590D_u4F7F_u7528_u6807_u70B9_u7B26_u53F7"><a href="#u4E0D_u91CD_u590D_u4F7F_u7528_u6807_u70B9_u7B26_u53F7" class="headerlink" title="不重复使用标点符号"></a>不重复使用标点符号</h3><p>正确：</p>
<blockquote>
<p>德国队竟然战胜了巴西队！</p>
<p>她竟然对你说「喵」？！</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>德国队竟然战胜了巴西队！！</p>
<p>德国队竟然战胜了巴西队！！！！！！！！</p>
<p>她竟然对你说「喵」？？！！</p>
<p>她竟然对你说「喵」？！？！？？！！</p>
</blockquote>
<h2 id="u5168_u89D2_u548C_u534A_u89D2"><a href="#u5168_u89D2_u548C_u534A_u89D2" class="headerlink" title="全角和半角"></a>全角和半角</h2><p>不明白什么是全角（全形）与半角（半形）符号？请查看维基百科词条『<a href="http://zh.wikipedia.org/wiki/%E5%85%A8%E5%BD%A2%E5%92%8C%E5%8D%8A%E5%BD%A2" target="_blank" rel="external">全角和半角</a>』。</p>
<h3 id="u4F7F_u7528_u5168_u89D2_u4E2D_u6587_u6807_u70B9"><a href="#u4F7F_u7528_u5168_u89D2_u4E2D_u6587_u6807_u70B9" class="headerlink" title="使用全角中文标点"></a>使用全角中文标点</h3><p>正确：</p>
<blockquote>
<p>嗨！你知道嘛？今天前台的小妹跟我说「喵」了哎！</p>
<p>核磁共振成像（NMRI）是什么原理都不知道？JFGI！</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>嗨! 你知道嘛? 今天前台的小妹跟我说 “喵” 了哎!</p>
<p>嗨!你知道嘛?今天前台的小妹跟我说”喵”了哎!</p>
<p>核磁共振成像 (NMRI) 是什么原理都不知道? JFGI!</p>
<p>核磁共振成像(NMRI)是什么原理都不知道?JFGI!</p>
</blockquote>
<h3 id="u6570_u5B57_u4F7F_u7528_u534A_u89D2_u5B57_u7B26"><a href="#u6570_u5B57_u4F7F_u7528_u534A_u89D2_u5B57_u7B26" class="headerlink" title="数字使用半角字符"></a>数字使用半角字符</h3><p>正确：</p>
<blockquote>
<p>这件蛋糕只卖 1000 元。</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>这件蛋糕只卖 １０００ 元。</p>
</blockquote>
<p>例外：在设计稿、宣传海报中如出现极少量数字的情形时，为方便文字对齐，是可以使用全角数字的。</p>
<h3 id="u9047_u5230_u5B8C_u6574_u7684_u82F1_u6587_u6574_u53E5_u3001_u7279_u6B8A_u540D_u8BCD_uFF0C_u5176_u5167_u5BB9_u4F7F_u7528_u534A_u89D2_u6807_u70B9"><a href="#u9047_u5230_u5B8C_u6574_u7684_u82F1_u6587_u6574_u53E5_u3001_u7279_u6B8A_u540D_u8BCD_uFF0C_u5176_u5167_u5BB9_u4F7F_u7528_u534A_u89D2_u6807_u70B9" class="headerlink" title="遇到完整的英文整句、特殊名词，其內容使用半角标点"></a>遇到完整的英文整句、特殊名词，其內容使用半角标点</h3><p>正确：</p>
<blockquote>
<p>乔布斯那句话是怎么说的？「Stay hungry, stay foolish.」。</p>
<p>推荐你阅读『Hackers &amp; Painters: Big Ideas from the Computer Age』，非常的有趣。</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>乔布斯那句话是怎么说的？「Stay hungry，stay foolish。」。</p>
<p>推荐你阅读『Hackers＆Painters：Big Ideas from the Computer Age』，非常的有趣。</p>
</blockquote>
<h2 id="u540D_u8BCD"><a href="#u540D_u8BCD" class="headerlink" title="名词"></a>名词</h2><h3 id="u4E13_u6709_u540D_u8BCD_u4F7F_u7528_u6B63_u786E_u7684_u5927_u5C0F_u5199"><a href="#u4E13_u6709_u540D_u8BCD_u4F7F_u7528_u6B63_u786E_u7684_u5927_u5C0F_u5199" class="headerlink" title="专有名词使用正确的大小写"></a>专有名词使用正确的大小写</h3><p>大小写相关用法原属于英文书写范畴，不属于本 wiki 讨论內容，在这里只对部分易错用法进行简述。</p>
<p>正确：</p>
<blockquote>
<p>使用 GitHub 登录</p>
<p>我们的客户有 GitHub、Foursquare、Microsoft Corporation、Google、Facebook, Inc.。</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>使用 github 登录</p>
<p>使用 GITHUB 登录</p>
<p>使用 Github 登录</p>
<p>使用 gitHub 登录</p>
<p>使用 gｲんĤЦ8 登录</p>
<p>我们的客户有 github、foursquare、microsoft corporation、google、facebook, inc.。</p>
<p>我们的客户有 GITHUB、FOURSQUARE、MICROSOFT CORPORATION、GOOGLE、FACEBOOK, INC.。</p>
<p>我们的客户有 Github、FourSquare、MicroSoft Corporation、Google、FaceBook, Inc.。</p>
<p>我们的客户有 gitHub、fourSquare、microSoft Corporation、google、faceBook, Inc.。</p>
<p>我们的客户有 gｲんĤЦ8、ｷouЯƧquﾑгє、๓เςг๏ร๏Ŧt ς๏гק๏гคtเ๏ภn、900913、ƒ4ᄃëв๏๏к, IПᄃ.。</p>
</blockquote>
<p>注意：当网页中需要配合整体视觉风格而出现全部大写／小写的情形，HTML 中请使用标准的大小写规范进行书写；并通过 <code>text-transform: uppercase;</code>／<code>text-transform: lowercase;</code> 对表现形式进行定义。</p>
<h3 id="u4E0D_u8981_u4F7F_u7528_u4E0D_u5730_u9053_u7684_u7F29_u5199"><a href="#u4E0D_u8981_u4F7F_u7528_u4E0D_u5730_u9053_u7684_u7F29_u5199" class="headerlink" title="不要使用不地道的缩写"></a>不要使用不地道的缩写</h3><p>正确：</p>
<blockquote>
<p>我们需要一位熟悉 JavaScript、HTML5，至少理解一种框架（如 Backbone.js、AngularJS、React 等）的前端开发者。</p>
</blockquote>
<p>错误：</p>
<blockquote>
<p>我们需要一位熟悉 Js、h5，至少理解一种框架（如 backbone、angular、RJS 等）的 FED。</p>
</blockquote>
<h2 id="u4E89_u8BAE"><a href="#u4E89_u8BAE" class="headerlink" title="争议"></a>争议</h2><p>以下用法略带有个人色彩，既：无论是否遵循下述规则，从语法的角度来讲都是<strong>正确</strong>的。</p>
<h3 id="u94FE_u63A5_u4E4B_u95F4_u589E_u52A0_u7A7A_u683C"><a href="#u94FE_u63A5_u4E4B_u95F4_u589E_u52A0_u7A7A_u683C" class="headerlink" title="链接之间增加空格"></a>链接之间增加空格</h3><p>用法：</p>
<blockquote>
<p>请 <a href="/#">提交一个 issue</a> 并分配给相关同事。</p>
<p>访问我们网站的最新动态，请 <a href="/#">点击这里</a> 进行订阅！</p>
</blockquote>
<p>对比用法：</p>
<blockquote>
<p>请<a href="/#">提交一个 issue</a> 并分配给相关同事。</p>
<p>访问我们网站的最新动态，请<a href="/#">点击这里</a>进行订阅！</p>
</blockquote>
<h3 id="u7B80_u4F53_u4E2D_u6587_u4F7F_u7528_u76F4_u89D2_u5F15_u53F7"><a href="#u7B80_u4F53_u4E2D_u6587_u4F7F_u7528_u76F4_u89D2_u5F15_u53F7" class="headerlink" title="简体中文使用直角引号"></a>简体中文使用直角引号</h3><p>用法：</p>
<blockquote>
<p>「老师，『有条不紊』的『紊』是什么意思？」</p>
</blockquote>
<p>对比用法：</p>
<blockquote>
<p>“老师，‘有条不紊’的‘紊’是什么意思？”</p>
</blockquote>
<h2 id="u5DE5_u5177"><a href="#u5DE5_u5177" class="headerlink" title="工具"></a>工具</h2><table>
<thead>
<tr>
<th>仓库</th>
<th>语言</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/vinta/paranoid-auto-spacing" target="_blank" rel="external">vinta/paranoid-auto-spacing</a></td>
<td>JavaScript</td>
</tr>
<tr>
<td><a href="https://github.com/huei90/pangu.node" target="_blank" rel="external">huei90/pangu.node</a></td>
<td>Node.js</td>
</tr>
<tr>
<td><a href="https://github.com/huacnlee/auto-correct" target="_blank" rel="external">huacnlee/auto-correct</a></td>
<td>Ruby</td>
</tr>
<tr>
<td><a href="https://github.com/sparanoid/space-lover" target="_blank" rel="external">sparanoid/space-lover</a></td>
<td>PHP (WordPress)</td>
</tr>
<tr>
<td><a href="https://github.com/NauxLiu/auto-correct" target="_blank" rel="external">nauxliu/auto-correct</a></td>
<td>PHP</td>
</tr>
<tr>
<td><a href="https://github.com/hotoo/pangu.vim" target="_blank" rel="external">hotoo/pangu.vim</a></td>
<td>Vim</td>
</tr>
<tr>
<td><a href="https://github.com/sparanoid/grunt-auto-spacing" target="_blank" rel="external">sparanoid/grunt-auto-spacing</a></td>
<td>Node.js (Grunt)</td>
</tr>
<tr>
<td><a href="https://github.com/hjiang/scripts/blob/master/add-space-between-latin-and-cjk" target="_blank" rel="external">hjiang/scripts/add-space-between-latin-and-cjk</a></td>
<td>Python</td>
</tr>
</tbody>
</table>
<h2 id="u8C01_u5728_u8FD9_u6837_u505A_uFF1F"><a href="#u8C01_u5728_u8FD9_u6837_u505A_uFF1F" class="headerlink" title="谁在这样做？"></a>谁在这样做？</h2><table>
<thead>
<tr>
<th>网站</th>
<th>文案</th>
<th>UGC</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://www.apple.com/cn/" target="_blank" rel="external">Apple 中国</a></td>
<td>Yes</td>
<td>N/A</td>
</tr>
<tr>
<td><a href="http://www.apple.com/hk/" target="_blank" rel="external">Apple 香港</a></td>
<td>Yes</td>
<td>N/A</td>
</tr>
<tr>
<td><a href="http://www.apple.com/tw/" target="_blank" rel="external">Apple 台湾</a></td>
<td>Yes</td>
<td>N/A</td>
</tr>
<tr>
<td><a href="http://www.microsoft.com/zh-cn/" target="_blank" rel="external">Microsoft 中国</a></td>
<td>Yes</td>
<td>N/A</td>
</tr>
<tr>
<td><a href="http://www.microsoft.com/zh-hk/" target="_blank" rel="external">Microsoft 香港</a></td>
<td>Yes</td>
<td>N/A</td>
</tr>
<tr>
<td><a href="http://www.microsoft.com/zh-tw/" target="_blank" rel="external">Microsoft 台湾</a></td>
<td>Yes</td>
<td>N/A</td>
</tr>
<tr>
<td><a href="http://leancloud.cn/" target="_blank" rel="external">LeanCloud</a></td>
<td>Yes</td>
<td>N/A</td>
</tr>
<tr>
<td><a href="http://www.zhihu.com/" target="_blank" rel="external">知乎</a></td>
<td>Yes</td>
<td>部分用户达成</td>
</tr>
<tr>
<td><a href="http://www.v2ex.com/" target="_blank" rel="external">V2EX</a></td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><a href="http://segmentfault.com/" target="_blank" rel="external">SegmentFault</a></td>
<td>Yes</td>
<td>部分用户达成</td>
</tr>
<tr>
<td><a href="http://apple4us.com/" target="_blank" rel="external">Apple4us</a></td>
<td>Yes</td>
<td>N/A</td>
</tr>
<tr>
<td><a href="http://www.wandoujia.com/" target="_blank" rel="external">豌豆荚</a></td>
<td>Yes</td>
<td>N/A</td>
</tr>
<tr>
<td><a href="http://ruby-china.org/" target="_blank" rel="external">Ruby China</a></td>
<td>Yes</td>
<td>标题达成</td>
</tr>
<tr>
<td><a href="http://phphub.org/" target="_blank" rel="external">PHPHub</a></td>
<td>Yes</td>
<td>标题达成</td>
</tr>
</tbody>
</table>
<h2 id="u53C2_u8003_u6587_u732E"><a href="#u53C2_u8003_u6587_u732E" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="http://grammar.about.com/od/punctuationandmechanics/a/Guidelines-For-Using-Capital-Letters.htm" target="_blank" rel="external">Guidelines for Using Capital Letters</a></li>
<li><a href="http://en.wikipedia.org/wiki/Letter_case" target="_blank" rel="external">Letter case - Wikipedia</a></li>
<li><a href="http://www.oxforddictionaries.com/us/words/punctuation" target="_blank" rel="external">Punctuation - Oxford Dictionaries</a></li>
<li><a href="https://owl.english.purdue.edu/owl/section/1/6/" target="_blank" rel="external">Punctuation - The Purdue OWL</a></li>
<li><a href="http://www.wikihow.com/Use-English-Punctuation-Correctly" target="_blank" rel="external">How to Use English Punctuation Corrently - wikiHow</a></li>
<li><a href="https://zh.opensuse.org/index.php?title=Help:%E6%A0%BC%E5%BC%8F" target="_blank" rel="external">格式 - openSUSE</a></li>
<li><a href="http://zh.wikipedia.org/wiki/%E5%85%A8%E5%BD%A2%E5%92%8C%E5%8D%8A%E5%BD%A2" target="_blank" rel="external">全角和半角 - 维基百科</a></li>
<li><a href="http://zh.wikipedia.org/wiki/%E5%BC%95%E8%99%9F" target="_blank" rel="external">引号 - 维基百科</a></li>
<li><a href="http://zh.wikipedia.org/wiki/%E7%96%91%E5%95%8F%E9%A9%9A%E5%98%86%E8%99%9F" target="_blank" rel="external">疑问惊叹号 - 维基百科</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/杂谈/">杂谈</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/markdown/">markdown</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/post/hello-world.html" class="article-date">
      <time datetime="2016-01-17T08:40:09.342Z" itemprop="datePublished">2016-01-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/hello-world.html">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start"><a href="#Quick_Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create_a_new_post"><a href="#Create_a_new_post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server"><a href="#Run_server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files"><a href="#Generate_static_files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites"><a href="#Deploy_to_remote_sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 Zous
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
            </div>
        </div>
        <div class="visit">
            <span id="busuanzi_container_site_pv" style='display:none'>
                <span id="site-visit" >本站到访数: 
                    <span id="busuanzi_value_site_uv"></span>
                </span>
            </span>
            <span id="busuanzi_container_page_pv" style='display:none'>
                <span id="page-visit">, 本页阅读量: 
                    <span id="busuanzi_value_page_pv"></span>
                </span>
            </span>
        </div>
    </div>
</footer>
    </div>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>